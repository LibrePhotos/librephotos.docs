"use strict";(self.webpackChunklibrephotos_docs=self.webpackChunklibrephotos_docs||[]).push([[8766],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var d=r.createContext({}),p=function(e){var t=r.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(d.Provider,{value:t},e.children)},s="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,d=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),s=p(n),u=o,k=s["".concat(d,".").concat(u)]||s[u]||m[u]||a;return n?r.createElement(k,i(i({ref:t},c),{},{components:n})):r.createElement(k,i({ref:t},c))}));function k(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=u;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[s]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},8304:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var r=n(7462),o=(n(7294),n(3905));const a={title:"\ud83d\udc0b Docker",excerpt:"Contributing to LibrePhotos Docker infrastructure.",last_modified_at:new Date("2024-12-14T00:00:00.000Z"),category:5},i=void 0,l={unversionedId:"development/contribution/docker",id:"development/contribution/docker",title:"\ud83d\udc0b Docker",description:"Overview",source:"@site/docs/development/contribution/docker.md",sourceDirName:"development/contribution",slug:"/development/contribution/docker",permalink:"/docs/development/contribution/docker",draft:!1,editUrl:"https://github.com/LibrePhotos/librephotos.docs/tree/master/docs/development/contribution/docker.md",tags:[],version:"current",frontMatter:{title:"\ud83d\udc0b Docker",excerpt:"Contributing to LibrePhotos Docker infrastructure.",last_modified_at:"2024-12-14T00:00:00.000Z",category:5},sidebar:"userguide",previous:{title:"Missing Photos Implementation",permalink:"/docs/development/contribution/backend/missing-photos"},next:{title:"\ud83d\udc68\u200d\ud83d\udcbb Frontend",permalink:"/docs/development/contribution/frontend/"}},d={},p=[{value:"Overview",id:"overview",level:2},{value:"\u2728 Code Standards",id:"-code-standards",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Container Relationships",id:"container-relationships",level:3},{value:"Development vs Production",id:"development-vs-production",level:3},{value:"Making Changes",id:"making-changes",level:2},{value:"Modifying the Backend Dockerfile",id:"modifying-the-backend-dockerfile",level:3},{value:"Modifying the Frontend Dockerfile",id:"modifying-the-frontend-dockerfile",level:3},{value:"Modifying the Proxy (Nginx)",id:"modifying-the-proxy-nginx",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Testing Changes",id:"testing-changes",level:2},{value:"GPU Support",id:"gpu-support",level:2},{value:"Common Issues",id:"common-issues",level:2},{value:"Image Size",id:"image-size",level:3},{value:"Build Performance",id:"build-performance",level:3},{value:"Volume Permissions",id:"volume-permissions",level:3}],c={toc:p},s="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(s,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"librephotos-docker")," repository contains the Docker configuration for running LibrePhotos. This includes:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," - Production configuration"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"docker-compose.dev.yml")," - Development overrides"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"backend/")," - Backend Dockerfile and entrypoint"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"frontend/")," - Frontend Dockerfile and development config"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"proxy/")," - Nginx reverse proxy configuration")),(0,o.kt)("h2",{id:"-code-standards"},"\u2728 Code Standards"),(0,o.kt)("p",null,"When modifying Docker files, please ensure:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Cross-platform compatibility"),": Test on both Linux and macOS/Windows (WSL2)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"ARM64 support"),": Images should build on both AMD64 and ARM64 (Apple Silicon, Raspberry Pi)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Layer optimization"),": Order commands to maximize Docker layer caching"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Security"),": Don't run services as root when avoidable; use minimal base images")),(0,o.kt)("h2",{id:"architecture"},"Architecture"),(0,o.kt)("h3",{id:"container-relationships"},"Container Relationships"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502   proxy     \u2502 :80\n                    \u2502   (nginx)   \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502              \u2502              \u2502\n      \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510\n      \u2502 frontend  \u2502  \u2502  backend  \u2502  \u2502  static   \u2502\n      \u2502  (React)  \u2502  \u2502 (Django)  \u2502  \u2502  files    \u2502\n      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n                     \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510\n                     \u2502    db     \u2502\n                     \u2502(Postgres) \u2502\n                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("h3",{id:"development-vs-production"},"Development vs Production"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"File"),(0,o.kt)("th",{parentName:"tr",align:null},"Purpose"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"docker-compose.yml")),(0,o.kt)("td",{parentName:"tr",align:null},"Base configuration, used in both dev and prod")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"docker-compose.dev.yml")),(0,o.kt)("td",{parentName:"tr",align:null},"Development overrides (hot reload, mounted source, debug tools)")))),(0,o.kt)("h2",{id:"making-changes"},"Making Changes"),(0,o.kt)("h3",{id:"modifying-the-backend-dockerfile"},"Modifying the Backend Dockerfile"),(0,o.kt)("p",null,"The backend Dockerfile (",(0,o.kt)("inlineCode",{parentName:"p"},"backend/Dockerfile"),") builds the Django application:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd librephotos-docker\n\n# Test your changes\ndocker compose -f docker-compose.yml -f docker-compose.dev.yml build backend\ndocker compose -f docker-compose.yml -f docker-compose.dev.yml up -d backend\n\n# Check logs for errors\ndocker compose logs -f backend\n")),(0,o.kt)("h3",{id:"modifying-the-frontend-dockerfile"},"Modifying the Frontend Dockerfile"),(0,o.kt)("p",null,"The frontend has two Dockerfiles:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"frontend/Dockerfile")," - Production build (static files served by nginx)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"frontend/Dockerfile.dev")," - Development build (hot reload)")),(0,o.kt)("h3",{id:"modifying-the-proxy-nginx"},"Modifying the Proxy (Nginx)"),(0,o.kt)("p",null,"The proxy configuration is in ",(0,o.kt)("inlineCode",{parentName:"p"},"proxy/nginx.conf"),". After changes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker compose -f docker-compose.yml -f docker-compose.dev.yml build proxy\ndocker compose -f docker-compose.yml -f docker-compose.dev.yml up -d proxy\n")),(0,o.kt)("h2",{id:"environment-variables"},"Environment Variables"),(0,o.kt)("p",null,"Environment variables are loaded from the ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file. Key variables for Docker:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Variable"),(0,o.kt)("th",{parentName:"tr",align:null},"Purpose"),(0,o.kt)("th",{parentName:"tr",align:null},"Default"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"tag")),(0,o.kt)("td",{parentName:"tr",align:null},"Docker image tag to use"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"latest"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"httpPort")),(0,o.kt)("td",{parentName:"tr",align:null},"Host port for the application"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"3000"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"codedir")),(0,o.kt)("td",{parentName:"tr",align:null},"(Dev only) Path to source code"),(0,o.kt)("td",{parentName:"tr",align:null},"-")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"scanDirectory")),(0,o.kt)("td",{parentName:"tr",align:null},"Path to photo library"),(0,o.kt)("td",{parentName:"tr",align:null},"-")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"data")),(0,o.kt)("td",{parentName:"tr",align:null},"Path to persistent data"),(0,o.kt)("td",{parentName:"tr",align:null},"-")))),(0,o.kt)("h2",{id:"testing-changes"},"Testing Changes"),(0,o.kt)("p",null,"Before submitting a PR:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Clean build"),": ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose build --no-cache")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Fresh start"),": ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose down -v && docker compose up -d")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Check all services"),": ",(0,o.kt)("inlineCode",{parentName:"li"},"docker compose ps"),' (all should be "healthy" or "running")'),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Test basic functionality"),": Upload a photo, trigger a scan, verify it works")),(0,o.kt)("h2",{id:"gpu-support"},"GPU Support"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"backend-gpu/")," directory contains GPU-enabled Dockerfiles for NVIDIA CUDA support:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# Build GPU image\ndocker compose -f docker-compose.yml -f docker-compose.gpu.yml build\n\n# Run with GPU\ndocker compose -f docker-compose.yml -f docker-compose.gpu.yml up -d\n")),(0,o.kt)("p",null,"Ensure you have:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"NVIDIA drivers installed"),(0,o.kt)("li",{parentName:"ul"},"nvidia-container-toolkit configured"),(0,o.kt)("li",{parentName:"ul"},"Docker configured to use the nvidia runtime")),(0,o.kt)("h2",{id:"common-issues"},"Common Issues"),(0,o.kt)("h3",{id:"image-size"},"Image Size"),(0,o.kt)("p",null,"Keep images small by:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Using multi-stage builds"),(0,o.kt)("li",{parentName:"ul"},"Cleaning apt/pip caches in the same layer"),(0,o.kt)("li",{parentName:"ul"},"Using ",(0,o.kt)("inlineCode",{parentName:"li"},".dockerignore")," to exclude unnecessary files")),(0,o.kt)("h3",{id:"build-performance"},"Build Performance"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Order Dockerfile commands from least to most frequently changed"),(0,o.kt)("li",{parentName:"ul"},"Copy dependency files before source code for better caching"),(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"--parallel")," flag for multi-service builds")),(0,o.kt)("h3",{id:"volume-permissions"},"Volume Permissions"),(0,o.kt)("p",null,"If you encounter permission issues with mounted volumes on Linux:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# Check the UID/GID of files in the container\ndocker exec -it backend ls -la /data\n\n# You may need to adjust ownership\nsudo chown -R $(id -u):$(id -g) ./librephotos/data\n")))}m.isMDXComponent=!0}}]);